name: Create Release

on:
  push:
    branches:
      - main
    paths:
      - 'package.json'
      - 'app.config.js'
      - 'CHANGELOG.md'
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '21'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Get version from package.json
        id: get_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Extract changelog content
        id: changelog
        run: |
          # è®€å– CHANGELOG.md æª”æ¡ˆ
          if [ -f "CHANGELOG.md" ]; then
            # å°‹æ‰¾ç•¶å‰ç‰ˆæœ¬è™Ÿçš„ changelog å…§å®¹
            VERSION="${{ steps.get_version.outputs.version }}"
            
            # ä½¿ç”¨ awk æå–ç•¶å‰ç‰ˆæœ¬çš„ changelog å…§å®¹
            CHANGELOG_CONTENT=$(awk -v version="$VERSION" '
            BEGIN { in_section = 0; content = "" }
            /^## \['"$VERSION"'\]/ { in_section = 1; next }
            /^## \[/ && in_section { exit }
            in_section { 
              if (content != "" || $0 ~ /./) {
                content = content (content == "" ? "" : "\n") $0
              }
            }
            END { print content }
            ' CHANGELOG.md)
            
            # æ¸…ç†å…§å®¹ï¼ˆç§»é™¤é–‹é ­å’Œçµå°¾çš„ç©ºè¡Œï¼‰
            CHANGELOG_CONTENT=$(echo "$CHANGELOG_CONTENT" | sed '/^[[:space:]]*$/d')
            
            if [ -n "$CHANGELOG_CONTENT" ]; then
              echo "changelog_content<<EOF" >> $GITHUB_OUTPUT
              echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              echo "Changelog content extracted for version $VERSION"
            else
              echo "changelog_content=No changelog content found for version $VERSION" >> $GITHUB_OUTPUT
              echo "No changelog content found for version $VERSION"
            fi
          else
            echo "changelog_content=CHANGELOG.md not found" >> $GITHUB_OUTPUT
            echo "CHANGELOG.md not found"
          fi

      - name: Create release body file
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"

          # å¯«å…¥ Release bodyï¼Œä½¿ç”¨ printf é¿å… backtick è§£æå•é¡Œ
          printf "## ğŸ“‹ Release v%s\n\n" "${VERSION}" > release_body.md
          printf "%s\n\n" "${{ steps.changelog.outputs.changelog_content }}" >> release_body.md
          printf -- "---\n\n" >> release_body.md
          printf "### ğŸ“¦ Installation\n\n" >> release_body.md
          printf '```bash\n' >> release_body.md
          printf "# ä½¿ç”¨ Expo Go æƒæ QR Code\n" >> release_body.md
          printf "# æˆ–ä¸‹è¼‰ APK/IPA æª”æ¡ˆ\n" >> release_body.md
          printf '```\n\n' >> release_body.md
          printf "### ğŸ”— Links\n\n" >> release_body.md
          printf -- "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v%s)\n" "${VERSION}" >> release_body.md
          printf -- "- [Documentation](https://github.com/${{ github.repository }}/blob/main/README.md)\n\n" >> release_body.md
          printf -- "---\n\n" >> release_body.md
          printf "*This release was automatically generated by GitHub Actions*\n" >> release_body.md

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          release_name: Release v${{ steps.get_version.outputs.version }}
          body_path: release_body.md
          draft: false
          prerelease: false

      - name: Notify Release
        if: success()
        run: |
          echo "ğŸ‰ Release v${{ steps.get_version.outputs.version }} has been created successfully!"
          echo "ğŸ·ï¸ Git tag 'v${{ steps.get_version.outputs.version }}' has been created"
          echo "ğŸ“± EAS will automatically build and submit production apps based on the tag"
          echo "ğŸ“‹ Changelog has been updated..."
